<!doctype html>
<html lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
</head>

<body style="font-family:system-ui;padding:12px">
  <h3>Tarot: ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª ‚Üí –≤–æ–ø—Ä–æ—Å ‚Üí 5 –∫–∞–¥—Ä–æ–≤ ‚Üí –æ—Ç–≤–µ—Ç</h3>

  <video id="v" autoplay playsinline
    style="width:100%;max-width:520px;border:1px solid #ccc;border-radius:12px"></video>

  <div style="margin:12px 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
    <button id="start">Start</button>
    <button id="stop">Stop</button>

    <label>Interval (sec):
      <input id="sec" type="number" value="3" min="1" step="1" style="width:60px">
    </label>

    <label>Frames:
      <input id="count" type="number" value="5" min="1" max="10" step="1" style="width:60px">
    </label>
  </div>

  <div style="margin:12px 0">
    <div><b>üéß Voice:</b> <span id="mic" style="opacity:.8"></span></div>
    <div style="margin-top:8px"><b>‚ùì Question:</b></div>
    <div id="q" style="white-space:pre-wrap;background:#eef;padding:10px;border-radius:10px;min-height:36px"></div>

    <div style="margin-top:10px"><b>üì∑ Capture:</b> <span id="cap" style="opacity:.8"></span></div>
  </div>

  <pre id="out" style="white-space:pre-wrap;background:#f6f6f6;padding:10px;border-radius:10px"></pre>

<script>
const WEBHOOK_URL = "https://dinodi.app.n8n.cloud/webhook/06663b29-629e-409b-bf14-104d6d419d32";

const WAKE_PHRASE = "–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ";
const SILENCE_MS = 3000;

let stream = null;

let captureMode = false;
let capturedText = "";
let silenceTimer = null;

let isBusy = false;
let rec = null;
let manualStopSpeech = false;

const micEl = document.getElementById("mic");
const qEl = document.getElementById("q");
const outEl = document.getElementById("out");
const capEl = document.getElementById("cap");

function setMic(t){ micEl.textContent = t; }
function setQ(t){ qEl.textContent = t || ""; }
function setCap(t){ capEl.textContent = t || ""; }
function log(t){ outEl.textContent = t; }

function normalizeRu(s){
  return (s || "")
    .toLowerCase()
    .replace(/—ë/g, "–µ")
    .replace(/[^\p{L}\p{N}\s]+/gu, " ")
    .replace(/\s+/g, " ")
    .trim();
}

async function startCam(){
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } },
    audio: false
  });
  document.getElementById("v").srcObject = stream;
}

function stopCam(){
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
}

async function getFrameBlob(){
  const video = document.getElementById("v");
  if (!video.videoWidth || !video.videoHeight) return null;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);

  return await new Promise(r => canvas.toBlob(r, "image/jpeg", 0.85));
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function captureNFramesAndSend(question){
  const sec = Math.max(1, Number(document.getElementById("sec").value || 3));
  const count = Math.min(10, Math.max(1, Number(document.getElementById("count").value || 5)));

  setCap(`–ì–æ—Ç–æ–≤–ª—é ${count} –∫–∞–¥—Ä–æ–≤ (–∫–∞–∂–¥—ã–µ ${sec} —Å–µ–∫)‚Ä¶`);
  const frames = [];

  for (let i = 1; i <= count; i++){
    setCap(`–°–Ω–∏–º–∞—é –∫–∞–¥—Ä ${i}/${count}‚Ä¶`);
    const blob = await getFrameBlob();
    if (blob) frames.push({ idx: i, blob });
    await sleep(sec * 1000);
  }

  setCap(`–û—Ç–ø—Ä–∞–≤–ª—è—é ${frames.length}/${count} –∫–∞–¥—Ä–æ–≤ –∏ –≤–æ–ø—Ä–æ—Å‚Ä¶`);
  const fd = new FormData();
  fd.append("question", question);

  // –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º 5 —Ñ–∞–π–ª–æ–≤: image1..image5
  frames.forEach(f => fd.append(`image${f.idx}`, f.blob, `frame${f.idx}.jpg`));

  const res = await fetch(WEBHOOK_URL, { method: "POST", body: fd });
  const text = await res.text();

  log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.\n\n‚ùì ${question}\n\n–û—Ç–≤–µ—Ç:\n${text}`);
  setCap("‚úÖ –ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ —Å–Ω–æ–≤–∞: ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª");
}

function armSilenceCommit(){
  clearTimeout(silenceTimer);
  silenceTimer = setTimeout(async () => {
    if (!captureMode || isBusy) return;

    const finalQ = capturedText.trim();
    if (finalQ.length < 2){
      captureMode = false;
      capturedText = "";
      setQ("");
      setMic("‚ö†Ô∏è –í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ü–æ–≤—Ç–æ—Ä–∏: ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª –∏ –≤–æ–ø—Ä–æ—Å.");
      return;
    }

    captureMode = false;
    capturedText = "";
    setQ(finalQ);

    isBusy = true;
    setMic("‚úÖ –í–æ–ø—Ä–æ—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω. –°–µ–π—á–∞—Å —Å–Ω–∏–º—É 5 –∫–∞–¥—Ä–æ–≤‚Ä¶");
    log("‚è≥ –ñ–¥—É –∫–∞–¥—Ä—ã‚Ä¶ –¥–µ—Ä–∂–∏ –∫–∞—Ä—Ç—ã –≤ –∫–∞–¥—Ä–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ.");
    try{
      await captureNFramesAndSend(finalQ);
    } catch(e){
      log("‚ùå –û—à–∏–±–∫–∞: " + (e?.message || e));
      setCap("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.");
    }
    isBusy = false;
    setMic("üéß –°–ª—É—à–∞—é‚Ä¶ —Å–∫–∞–∂–∏: ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª");
  }, SILENCE_MS);
}

function startSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){
    setMic("‚ùå SpeechRecognition –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–ª—É—á—à–µ Chrome).");
    return;
  }
  if (rec) return;

  manualStopSpeech = false;
  rec = new SR();
  rec.lang = "ru-RU";
  rec.continuous = true;
  rec.interimResults = true;

  rec.onstart = () => setMic("üéß –°–ª—É—à–∞—é‚Ä¶ —Å–∫–∞–∂–∏: ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª");

  rec.onresult = (e) => {
    if (isBusy) return; // –ø–æ–∫–∞ —Å–Ω–∏–º–∞–µ–º –∫–∞–¥—Ä—ã ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≥–æ–ª–æ—Å

    let finalText = "";
    for (let i = e.resultIndex; i < e.results.length; i++){
      if (e.results[i].isFinal) finalText += e.results[i][0].transcript + " ";
    }
    if (!finalText.trim()) return;

    const norm = normalizeRu(finalText);
    const wakeNorm = normalizeRu(WAKE_PHRASE);

    // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∑–∞—Ö–≤–∞—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∫–æ–¥–æ–≤–æ–π —Ñ—Ä–∞–∑—ã
    if (!captureMode && norm.includes(wakeNorm)){
      captureMode = true;

      // —Ö–≤–æ—Å—Ç –ø–æ—Å–ª–µ ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª (–µ—Å–ª–∏ –≤ —Ç–æ–π –∂–µ —Ñ—Ä–∞–∑–µ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å)
      const idx = norm.indexOf(wakeNorm);
      const after = norm.slice(idx + wakeNorm.length).trim();
      capturedText = after ? after : "";

      setMic("üéôÔ∏è –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å‚Ä¶ (–∑–∞–º–æ–ª—á–∏ –Ω–∞ 3 —Å–µ–∫ ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä—É—é)");
      setQ(capturedText);
      armSilenceCommit();
      return;
    }

    // –ï—Å–ª–∏ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ –∑–∞—Ö–≤–∞—Ç–∞ ‚Äî –¥–æ–ø–∏—Å—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
    if (captureMode){
      capturedText += (capturedText ? " " : "") + finalText.trim();
      setQ(capturedText);
      armSilenceCommit();
    }
  };

  rec.onend = () => {
    if (!manualStopSpeech) setTimeout(() => { try{ rec.start(); } catch(_){} }, 400);
  };

  rec.onerror = () => {};
  try{ rec.start(); } catch(_){}
}

function stopSpeech(){
  manualStopSpeech = true;
  try { if (rec) rec.stop(); } catch(_){}
  rec = null;
}

document.getElementById("start").onclick = async () => {
  await startCam();
  startSpeech();
  setCap("‚è∏ –û–∂–∏–¥–∞—é –≤–æ–ø—Ä–æ—Å‚Ä¶");
  log("‚úÖ –ì–æ—Ç–æ–≤–æ. –°–∫–∞–∂–∏: ¬´–∫–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä–∏—Ç–µ¬ª, –∑–∞—Ç–µ–º –≤–æ–ø—Ä–æ—Å.");
};

document.getElementById("stop").onclick = () => {
  clearTimeout(silenceTimer);
  captureMode = false;
  capturedText = "";
  setQ("");
  setCap("‚èπ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
  setMic("");
  stopSpeech();
  stopCam();
  log("Stopped.");
};
</script>

</body>
</html>
